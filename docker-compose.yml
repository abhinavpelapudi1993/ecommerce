services:
  # ── Infrastructure ─────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ecommerce
      POSTGRES_PASSWORD: ecommerce
      POSTGRES_DB: ecommerce
    ports:
      - '5432:5432'
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ecommerce']
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 5s
      retries: 5

  kafka:
    image: apache/kafka:3.7.0
    ports:
      - '9092:9092'
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: 'ecommerce-kafka-cluster-001'
    volumes:
      - kafkadata:/var/lib/kafka/data
    healthcheck:
      test: ['CMD-SHELL', '/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1']
      interval: 10s
      timeout: 10s
      retries: 10

  # ── ELK Stack ────────────────────────────────────────────────
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - '9200:9200'
    volumes:
      - esdata:/var/lib/elasticsearch/data
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:9200/_cluster/health || exit 1']
      interval: 10s
      timeout: 5s
      retries: 10

  logstash:
    image: docker.elastic.co/logstash/logstash:8.12.0
    volumes:
      - ./elk/logstash/pipeline:/usr/share/logstash/pipeline:ro
    ports:
      - '5044:5044'
    environment:
      - "LS_JAVA_OPTS=-Xms256m -Xmx256m"
    depends_on:
      elasticsearch:
        condition: service_healthy

  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.0
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - '5601:5601'
    depends_on:
      elasticsearch:
        condition: service_healthy

  kibana-setup:
    image: curlimages/curl:8.5.0
    volumes:
      - ./elk/kibana/setup-data-view.sh:/setup.sh:ro
    entrypoint: ['/bin/sh', '/setup.sh']
    environment:
      KIBANA_URL: http://kibana:5601
    depends_on:
      - kibana
      - logstash

  # ── Microservices ──────────────────────────────────────────────
  customer-api:
    build:
      context: .
      dockerfile: services/Dockerfile
      args:
        SERVICE: customer-api
    ports:
      - '3001:3001'
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ecommerce
      DB_PASSWORD: ecommerce
      DB_NAME: ecommerce
      PORT: 3001
      SERVICE_NAME: customer-api
      LOG_DIR: /var/log/app
    volumes:
      - customer-api-logs:/var/log/app
    depends_on:
      postgres:
        condition: service_healthy

  product-api:
    build:
      context: .
      dockerfile: services/Dockerfile
      args:
        SERVICE: product-api
    ports:
      - '3002:3002'
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ecommerce
      DB_PASSWORD: ecommerce
      DB_NAME: ecommerce
      PORT: 3002
      SERVICE_NAME: product-api
      LOG_DIR: /var/log/app
    volumes:
      - product-api-logs:/var/log/app
    depends_on:
      postgres:
        condition: service_healthy

  shipment-api:
    build:
      context: .
      dockerfile: services/Dockerfile
      args:
        SERVICE: shipment-api
    ports:
      - '3003:3003'
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ecommerce
      DB_PASSWORD: ecommerce
      DB_NAME: ecommerce
      PORT: 3003
      SERVICE_NAME: shipment-api
      LOG_DIR: /var/log/app
    volumes:
      - shipment-api-logs:/var/log/app
    depends_on:
      postgres:
        condition: service_healthy

  backend:
    build:
      context: .
      dockerfile: services/Dockerfile
      args:
        SERVICE: backend
    ports:
      - '3000:3000'
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ecommerce
      DB_PASSWORD: ecommerce
      DB_NAME: ecommerce
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CUSTOMER_API_URL: http://customer-api:3001
      PRODUCT_API_URL: http://product-api:3002
      SHIPMENT_API_URL: http://shipment-api:3003
      KAFKA_BROKERS: kafka:9092
      PORT: 3000
      SERVICE_NAME: backend
      LOG_DIR: /var/log/app
    volumes:
      - backend-logs:/var/log/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      customer-api:
        condition: service_started
      product-api:
        condition: service_started
      shipment-api:
        condition: service_started
      kafka:
        condition: service_healthy

  # ── Filebeat Sidecars ────────────────────────────────────────
  filebeat-customer-api:
    image: docker.elastic.co/beats/filebeat:8.12.0
    user: root
    volumes:
      - ./elk/filebeat/filebeat-customer-api.yml:/usr/share/filebeat/filebeat.yml:ro
      - customer-api-logs:/var/log/app:ro
    depends_on:
      - customer-api
      - logstash

  filebeat-product-api:
    image: docker.elastic.co/beats/filebeat:8.12.0
    user: root
    volumes:
      - ./elk/filebeat/filebeat-product-api.yml:/usr/share/filebeat/filebeat.yml:ro
      - product-api-logs:/var/log/app:ro
    depends_on:
      - product-api
      - logstash

  filebeat-shipment-api:
    image: docker.elastic.co/beats/filebeat:8.12.0
    user: root
    volumes:
      - ./elk/filebeat/filebeat-shipment-api.yml:/usr/share/filebeat/filebeat.yml:ro
      - shipment-api-logs:/var/log/app:ro
    depends_on:
      - shipment-api
      - logstash

  filebeat-backend:
    image: docker.elastic.co/beats/filebeat:8.12.0
    user: root
    volumes:
      - ./elk/filebeat/filebeat-backend.yml:/usr/share/filebeat/filebeat.yml:ro
      - backend-logs:/var/log/app:ro
    depends_on:
      - backend
      - logstash

  # ── Frontend Apps ──────────────────────────────────────────────
  customer-portal:
    build:
      context: .
      dockerfile: apps/Dockerfile
      args:
        APP: customer-portal
    ports:
      - '5173:80'
    depends_on:
      - backend

  support-dashboard:
    build:
      context: .
      dockerfile: apps/Dockerfile
      args:
        APP: support-dashboard
    ports:
      - '5174:80'
    depends_on:
      - backend

volumes:
  pgdata:
  esdata:
  kafkadata:
  customer-api-logs:
  product-api-logs:
  shipment-api-logs:
  backend-logs:
